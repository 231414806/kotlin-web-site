[//]: # (title: Compatibility guide for Kotlin Multiplatform Mobile)

This guide summarizes [incompatible changes](kotlin-evolution.md#incompatible-changes) you may encounter while
developing projects with Kotlin Multiplatform Mobile.

Mind the deprecation cycle of a specific change in relation to the Kotlin version you have in your projects. The current
Stable version of Kotlin is %kotlinVersion%.

## Auto-generated targets

**What's changed?**

Target accessors auto-generated by Gradle are no longer available inside the `kotlin.targets { }` block. Use
the `findByName("targetName")` method instead.

Note that such accessors are still available in the `kotlin.targets` case, for example, `kotlin.targets.linuxX64`.

**What's the best practice now?**

<table header-style="top">
    <tr>
        <td>Before</td>
        <td>Now</td>
    </tr>
    <tr>
<td>

```kotlin
kotlin {
    targets {
        configure(['windows', 'linux']) {
        }
    }
}
```

</td>
<td>

```kotlin
kotlin {
    targets {
        configure([findByName('windows'), findByName('linux')]) {
        }
    }
}
```

</td>
    </tr>
</table>

**When do the changes take effect?**

In Kotlin 1.7.20, an error is introduced when using targets accessors in the `kotlin.targets { }` block.

For more information, see the corresponding issue on [YouTrack](https://youtrack.jetbrains.com/issue/KT-47047).

## Gradle input and output compile tasks

**What's changed?**

Kotlin compile tasks no longer inherit the Gradle `AbstractCompile` task that has the `sourceCompatibility` and
`targetCompatibility` inputs, making them unavailable in Kotlin users' scripts.

Also, there are some other breaking changes in compile tasks you may encounter:

**What's the best practice now?**

| Before                                                              | Now                                                                                                            |
|---------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------|
| The `SourceTask.stableSources` input is no longer available.        | Use the `sources` input instead. Also, the `setSource()` methods are still available.                          |
| The `sourceFilesExtensions` input was removed.                      | Compile tasks still implement the `PatternFilterable` interface. Use its methods for filtering Kotlin sources. |
| The `Gradle destinationDir: File` output was deprecated.            | Use the `destinationDirectory: DirectoryProperty` output instead.                                              |
| The `classpath` property of the `KotlinCompile` task is deprecated. | All compile tasks now use the `libraries` input for a list of libraries required for compilation.              |

**When do the changes take effect?**

In Kotlin 1.7.20, inputs are not available, the output is replaced, and the `classpath` property is deprecated.

For more information, see the corresponding issue on [YouTrack](https://youtrack.jetbrains.com/issue/KT-32805).

## New configuration names for dependencies on the compilation

**What's changed?**

Compilation configurations created by the Kotlin Multiplatform Gradle Plugin received new names.

A target in the Kotlin Multiplatform project has two default compilations, `main` and `test`. Each of these compilations
has its own default source set, for example, `jvmMain` and `jvmTest`. Previously the configuration names for the test
compilation and its default source set were the same, which might lead to a name clash resulting in issues when a
configuration marked with platform-specific attributes is included in another configuration.

Now compilation configurations have an extra `Compilation` postfix, while projects and plugins that use old hard-coded
configuration names no longer compile.

Configuration names for dependencies on the corresponding source set stay the same.

**What's the best practice now?**

<table header-style="top">
    <tr>
        <td></td>
        <td>Before</td>
        <td>Now</td>
    </tr>
    <tr>
        <td rowspan="2">Dependencies of the <code>jvmMain</code> compilation</td>
<td>

```kotlin
jvm<Scope>
```

</td>
<td>

```kotlin
jvmCompilation<Scope>
```

</td>
    </tr>
    <tr>
<td>

```kotlin
dependencies {
    add("jvmImplementation", "foo.bar.baz:1.2.3")
}
```

</td>
<td>

```kotlin
dependencies {
    add("jvmCompilationImplementation", "foo.bar.baz:1.2.3")
}
```

</td>
    </tr>
    <tr>
        <td>Dependencies of the <code>jvmMain</code> source set</td>
<td colspan="2">

```kotlin
jvmMain<Scope>
```

</td>
    </tr>
    <tr>
        <td>Dependencies of the <code>jvmTest</code> compilation</td>
<td>

```kotlin
jvmTest<Scope>
```

</td>
<td>

```kotlin
jvmTestCompilation<Scope>
```

</td>
    </tr>
    <tr>
        <td>Dependencies of the <code>jvmTest</code> source set</td>
<td colspan="2">

```kotlin
jvmTest<Scope>
```

</td>
    </tr>
</table>

The available scopes are `Api`, `Implementation`, `CompileOnly`, and `RuntimeOnly`.

**When do the changes take effect?**

In Kotlin 1.8.0, an error is introduced when using old configuration names in hard-coded strings.

For more information, see the corresponding issue on [YouTrack](https://youtrack.jetbrains.com/issue/KT-35916/).

## Deprecated gradle.properties for hierarchical support

<anchor name="deprecate-hmpp-properties"></anchor> 

**Background**

Over the course of its evolution, Kotlin Multiplatform was gradually introducing support for so-called "hierarchical"
structure, i.e. an ability to have intermediate source sets between the root common source set (`commonMain`) and 
any platform-specific one (e.g. `jvmMain`). 

For the transition period, while the toolchain wasn't stable enough,
a couple of Gradle Properties were introduced, allowing granular opt-ins and opt-outs. 

Since Kotlin 1.7.20, full support for hierarchical structures was enabled by default. Properties were kept to allow
opting-out in case one suffers from blocking issues. After processing all the feedback, we're now starting phasing out
those properties completely.

**What has changed?**

The following properties has been deprecated and will be removed in Kotlin 1.9:

* `kotlin.internal.mpp.hierarchicalStructureByDefault`
* `kotlin.mpp.enableCompatibilityMetadataVariant`
* `kotlin.mpp.hierarchicalStructureSupport`
* `kotlin.mpp.enableGranularSourceSetsMetadata`

Since Kotlin 1.8.20 until Kotlin 1.9, Kotlin Gradle Plugin will issue a warning if the build sets those properties.

Starting with Kotlin 1.9, those properties will be silently ignored.

**What's the best practice now?**

* Remove those properties from your `gradle.properties`, `local.properties`
* Avoid setting them programmatically from Gradle buildscripts or your Gradle Plugins
* In case deprecated properties are set by some 3rd-party Gradle Plugin used in your build,
ask that plugin maintainer(s) to stop setting those properties. 

**Impact**

The following properties & values are redundant/obsolete at this point. No impact is expected, and you can safely remove
them:

* `kotlin.internal.mpp.hierarchicalStructureByDefault=true`
* `kotlin.mpp.enableCompatibilityMetadataVariant=false`
* `kotlin.mpp.hierarchicalStructureSupport=true`
* `kotlin.mpp.enableGranularSourceSetsMetadata=true`
* `kotlin.mpp.enableGranularSourceSetsMetadata=false`

The following properties & values are deprecated:  

* `kotlin.internal.mpp.hierarchicalStructureByDefault=false`
* `kotlin.mpp.enableCompatibilityMetadataVariant=true`
* `kotlin.mpp.hierarchicalStructureSupport=false`

As the default behavior of Kotlin toolchain since 1.7.20 corresponds to having no such properties, we do not expect
any serious impact from removing them. Most possible consequences will be visible immediately after the project rebuild.
If you're a library author and want to be extra safe, you can recheck that consumers are able to consume your library.

In the unlikely case you face some problems after removing those properties, please report it to https://kotlin.in/issue
